From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: skyouo0727 <skyouo@skyouo.engineer>
Date: Sat, 19 Apr 2025 15:31:39 +0800
Subject: [PATCH] Handle various entity tag dfu upgrade


diff --git a/src/main/java/org/bukkit/craftbukkit/inventory/CraftMetaArmorStand.java b/src/main/java/org/bukkit/craftbukkit/inventory/CraftMetaArmorStand.java
index bc7c22c477f799e49a12d7b132bd90b112d3fc56..b5127e33ad28174ed36d3bfb6ba7e57418221819 100644
--- a/src/main/java/org/bukkit/craftbukkit/inventory/CraftMetaArmorStand.java
+++ b/src/main/java/org/bukkit/craftbukkit/inventory/CraftMetaArmorStand.java
@@ -1,5 +1,7 @@
 package org.bukkit.craftbukkit.inventory;
 
+import ca.spottedleaf.dataconverter.minecraft.MCDataConverter;
+import ca.spottedleaf.dataconverter.minecraft.datatypes.MCTypeRegistry;
 import com.google.common.collect.ImmutableMap.Builder;
 import java.util.Map;
 import net.minecraft.core.component.DataComponentPatch;
@@ -7,6 +9,7 @@ import net.minecraft.core.component.DataComponents;
 import net.minecraft.nbt.CompoundTag;
 import net.minecraft.nbt.Tag;
 import net.minecraft.world.item.component.CustomData;
+import org.bukkit.Bukkit;
 import org.bukkit.Material;
 import org.bukkit.configuration.serialization.DelegateDeserialization;
 
@@ -184,6 +187,20 @@ public class CraftMetaArmorStand extends CraftMetaItem implements com.destroysto
         return builder;
     }
 
+    // Misteln start - perform nbt upgrade
+    @Override
+    public void setVersion(int version) {
+        super.setVersion(version);
+
+        if (version < Bukkit.getUnsafe().getDataVersion()) {
+            if (entityTag == null) return;
+
+            entityTag = MCDataConverter.convertTag(MCTypeRegistry.ENTITY, entityTag,
+                    version, Bukkit.getUnsafe().getDataVersion());
+        }
+    }
+    // Misteln end
+
     @Override
     public CraftMetaArmorStand clone() {
         CraftMetaArmorStand clone = (CraftMetaArmorStand) super.clone();
diff --git a/src/main/java/org/bukkit/craftbukkit/inventory/CraftMetaAxolotlBucket.java b/src/main/java/org/bukkit/craftbukkit/inventory/CraftMetaAxolotlBucket.java
index 3e1ef1afb61cb989e7a0d8c8c85bd894b4ef8fae..e2bdc65e72b56091efcc88b4e53533e3a5b814bb 100644
--- a/src/main/java/org/bukkit/craftbukkit/inventory/CraftMetaAxolotlBucket.java
+++ b/src/main/java/org/bukkit/craftbukkit/inventory/CraftMetaAxolotlBucket.java
@@ -1,5 +1,7 @@
 package org.bukkit.craftbukkit.inventory;
 
+import ca.spottedleaf.dataconverter.minecraft.MCDataConverter;
+import ca.spottedleaf.dataconverter.minecraft.datatypes.MCTypeRegistry;
 import com.google.common.collect.ImmutableMap;
 import java.util.Map;
 import net.minecraft.core.component.DataComponentPatch;
@@ -7,6 +9,7 @@ import net.minecraft.core.component.DataComponents;
 import net.minecraft.nbt.CompoundTag;
 import net.minecraft.nbt.Tag;
 import net.minecraft.world.item.component.CustomData;
+import org.bukkit.Bukkit;
 import org.bukkit.configuration.serialization.DelegateDeserialization;
 import org.bukkit.craftbukkit.util.CraftMagicNumbers;
 import org.bukkit.entity.Axolotl;
@@ -202,4 +205,18 @@ public class CraftMetaAxolotlBucket extends CraftMetaItem implements AxolotlBuck
 
         return builder;
     }
+
+    // Misteln start - perform nbt upgrade
+    @Override
+    public void setVersion(int version) {
+        super.setVersion(version);
+
+        if (version < Bukkit.getUnsafe().getDataVersion()) {
+            if (entityTag == null) return;
+
+            entityTag = MCDataConverter.convertTag(MCTypeRegistry.ENTITY, entityTag,
+                    version, Bukkit.getUnsafe().getDataVersion());
+        }
+    }
+    // Misteln end
 }
diff --git a/src/main/java/org/bukkit/craftbukkit/inventory/CraftMetaEntityTag.java b/src/main/java/org/bukkit/craftbukkit/inventory/CraftMetaEntityTag.java
index 37ea36bbf2278aa59ceae4894c73016d4abc19c2..772144c72fff613504dad6769ff9d6f19e24e25d 100644
--- a/src/main/java/org/bukkit/craftbukkit/inventory/CraftMetaEntityTag.java
+++ b/src/main/java/org/bukkit/craftbukkit/inventory/CraftMetaEntityTag.java
@@ -1,5 +1,7 @@
 package org.bukkit.craftbukkit.inventory;
 
+import ca.spottedleaf.dataconverter.minecraft.MCDataConverter;
+import ca.spottedleaf.dataconverter.minecraft.datatypes.MCTypeRegistry;
 import com.google.common.collect.ImmutableMap.Builder;
 import com.google.common.collect.Sets;
 import java.util.Map;
@@ -9,6 +11,7 @@ import net.minecraft.core.component.DataComponents;
 import net.minecraft.nbt.CompoundTag;
 import net.minecraft.nbt.Tag;
 import net.minecraft.world.item.component.CustomData;
+import org.bukkit.Bukkit;
 import org.bukkit.Material;
 import org.bukkit.configuration.serialization.DelegateDeserialization;
 
@@ -134,6 +137,20 @@ public class CraftMetaEntityTag extends CraftMetaItem {
         return builder;
     }
 
+    // Misteln start - perform nbt upgrade
+    @Override
+    public void setVersion(int version) {
+        super.setVersion(version);
+
+        if (version < Bukkit.getUnsafe().getDataVersion()) {
+            if (entityTag == null) return;
+
+            entityTag = MCDataConverter.convertTag(MCTypeRegistry.ENTITY, entityTag,
+                    version, Bukkit.getUnsafe().getDataVersion());
+        }
+    }
+    // Misteln end
+
     @Override
     public CraftMetaEntityTag clone() {
         CraftMetaEntityTag clone = (CraftMetaEntityTag) super.clone();
diff --git a/src/main/java/org/bukkit/craftbukkit/inventory/CraftMetaSpawnEgg.java b/src/main/java/org/bukkit/craftbukkit/inventory/CraftMetaSpawnEgg.java
index 633d68b727fa7d444a93865a25a5d5d56991ffef..d00c5116c4f94296abe3b1b8e5539f1c2d8ee2e1 100644
--- a/src/main/java/org/bukkit/craftbukkit/inventory/CraftMetaSpawnEgg.java
+++ b/src/main/java/org/bukkit/craftbukkit/inventory/CraftMetaSpawnEgg.java
@@ -1,5 +1,7 @@
 package org.bukkit.craftbukkit.inventory;
 
+import ca.spottedleaf.dataconverter.minecraft.MCDataConverter;
+import ca.spottedleaf.dataconverter.minecraft.datatypes.MCTypeRegistry;
 import com.google.common.base.Preconditions;
 import com.google.common.collect.ImmutableMap.Builder;
 import java.util.Map;
@@ -8,6 +10,7 @@ import net.minecraft.core.component.DataComponents;
 import net.minecraft.nbt.CompoundTag;
 import net.minecraft.nbt.Tag;
 import net.minecraft.world.item.component.CustomData;
+import org.bukkit.Bukkit;
 import org.bukkit.configuration.serialization.DelegateDeserialization;
 import org.bukkit.craftbukkit.entity.CraftEntitySnapshot;
 import org.bukkit.entity.EntitySnapshot;
@@ -175,6 +178,20 @@ public class CraftMetaSpawnEgg extends CraftMetaItem implements SpawnEggMeta {
         return builder;
     }
 
+    // Misteln start - perform nbt upgrade
+    @Override
+    public void setVersion(int version) {
+        super.setVersion(version);
+
+        if (version < Bukkit.getUnsafe().getDataVersion()) {
+            if (entityTag == null) return;
+
+            entityTag = MCDataConverter.convertTag(MCTypeRegistry.ENTITY, entityTag,
+                    version, Bukkit.getUnsafe().getDataVersion());
+        }
+    }
+    // Misteln end
+
     @Override
     public CraftMetaSpawnEgg clone() {
         CraftMetaSpawnEgg clone = (CraftMetaSpawnEgg) super.clone();
diff --git a/src/main/java/org/bukkit/craftbukkit/inventory/CraftMetaTropicalFishBucket.java b/src/main/java/org/bukkit/craftbukkit/inventory/CraftMetaTropicalFishBucket.java
index 9e2c84df3c6978b52f09a8a7e3015d3d526add19..869118e02d7a679d655a546bb05b9e98364e6b94 100644
--- a/src/main/java/org/bukkit/craftbukkit/inventory/CraftMetaTropicalFishBucket.java
+++ b/src/main/java/org/bukkit/craftbukkit/inventory/CraftMetaTropicalFishBucket.java
@@ -1,5 +1,7 @@
 package org.bukkit.craftbukkit.inventory;
 
+import ca.spottedleaf.dataconverter.minecraft.MCDataConverter;
+import ca.spottedleaf.dataconverter.minecraft.datatypes.MCTypeRegistry;
 import com.google.common.collect.ImmutableMap;
 import java.util.Map;
 import net.minecraft.core.component.DataComponentPatch;
@@ -7,6 +9,7 @@ import net.minecraft.core.component.DataComponents;
 import net.minecraft.nbt.CompoundTag;
 import net.minecraft.nbt.Tag;
 import net.minecraft.world.item.component.CustomData;
+import org.bukkit.Bukkit;
 import org.bukkit.DyeColor;
 import org.bukkit.configuration.serialization.DelegateDeserialization;
 import org.bukkit.craftbukkit.entity.CraftTropicalFish;
@@ -234,4 +237,18 @@ class CraftMetaTropicalFishBucket extends CraftMetaItem implements TropicalFishB
 
         return builder;
     }
+
+    // Misteln start - perform nbt upgrade
+    @Override
+    public void setVersion(int version) {
+        super.setVersion(version);
+
+        if (version < Bukkit.getUnsafe().getDataVersion()) {
+            if (entityTag == null) return;
+
+            entityTag = MCDataConverter.convertTag(MCTypeRegistry.ENTITY, entityTag,
+                    version, Bukkit.getUnsafe().getDataVersion());
+        }
+    }
+    // Misteln end
 }
